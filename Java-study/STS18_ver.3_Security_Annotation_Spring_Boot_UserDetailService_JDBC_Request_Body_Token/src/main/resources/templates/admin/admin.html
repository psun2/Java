<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN</title>
</head>
<body>
<h1>ADMIN</h1>
<!-- JSP 페이지에서 사용자 이름을 표시하기 위해 $ {pageContext.request.userPrincipal.name}을 사용합니다. -->
<p>
    <span sec:authentication="principal.username">demo</span>님이 로그인 상태
</p>

<div>
    <span th:text="${#authentication.getName()}"></span>
</div>

<div id="result"></div>

<div th:if="${_csrf.parameterName != null && _csrf.token != null && _csrf.headerName != null} ">
    <div th:text="${_csrf.parameterName}"></div>
    <div th:text="${_csrf.token}"></div>
    <div th:text="${_csrf.headerName}"></div>
</div>
<h1>Hello world!</h1>
<P th:text="'The time on the server is ' + ${serverTime} + '.'"></P>
<a href="/logout">로그아웃</a>

<button id="info">내정보 보기</button>

<script th:inline="javascript">
    const result = document.getElementById('result');
    const info = document.getElementById('info');
    const user = [[${#authentication.getName()}]];

    const userObj = {
        'username' : user
    }

    const handleAjax = () => {
        fetch("/userinfo", {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, cors, *same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                // 'Content-Type': 'application/x-www-form-urlencoded',
                [[${_csrf.headerName}]] : [[${_csrf.token}]]
            },
            redirect: 'follow', // manual, *follow, error
            referrer: 'no-referrer', // no-referrer, *client
            body: JSON.stringify(userObj), // body data type must match "Content-Type" header
        })
            .then(response => response.json()) // parses JSON response into native JavaScript objects
        .then(data => {
            result.innerHTML = `<div>${data.username}</div><div>${data.nickname}</div>`
        })
    }

    const init = () => {
        info.addEventListener('click', handleAjax);
    }

    init();
</script>
</body>
</html>